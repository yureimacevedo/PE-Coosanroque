<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PlaneaciÃ³n EstratÃ©gica - Sistema Completo</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#1F2937}.loading{display:flex;justify-content:center;align-items:center;height:100vh;color:white;font-size:1.5rem}.auth-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem}.auth-box{background:white;border-radius:16px;padding:2rem;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3)}.auth-header{text-align:center;margin-bottom:2rem}.auth-header h1{font-size:1.75rem;color:#4F46E5;margin-bottom:0.5rem}.form-group{margin-bottom:1.5rem}.form-group label{display:block;margin-bottom:0.5rem;font-weight:600;color:#374151}.form-group input,.form-group select,.form-group textarea{width:100%;padding:0.75rem;border:2px solid #E5E7EB;border-radius:8px;font-size:1rem}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#4F46E5}.btn-primary{width:100%;padding:0.875rem;border:none;background:linear-gradient(135deg,#4F46E5 0%,#7C3AED 100%);color:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;margin-bottom:1rem}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(79,70,229,0.3)}.btn-primary:disabled{opacity:0.5;cursor:not-allowed}.btn-secondary{padding:0.75rem 1.5rem;border:2px solid #E5E7EB;background:white;color:#6B7280;border-radius:8px;font-weight:600;cursor:pointer;margin-right:0.5rem}.btn-secondary:hover{border-color:#4F46E5;color:#4F46E5}.btn-edit{padding:0.5rem 1rem;border:2px solid #4F46E5;background:white;color:#4F46E5;border-radius:6px;font-weight:600;cursor:pointer;font-size:0.875rem;margin-right:0.5rem}.btn-edit:hover{background:#4F46E5;color:white}.error-message{background:#FEE2E2;color:#991B1B;padding:0.75rem;border-radius:8px;margin-bottom:1rem;font-size:0.875rem}.app-container{display:flex;min-height:100vh}.sidebar{width:280px;background:rgba(255,255,255,0.95);display:flex;flex-direction:column;box-shadow:4px 0 24px rgba(0,0,0,0.08)}.sidebar-header{padding:2rem 1.5rem;background:linear-gradient(135deg,#4F46E5 0%,#7C3AED 100%);color:white}.sidebar-header h2{font-size:1.5rem;font-weight:700}.selector-entidad{padding:1rem 1.5rem;background:#F9FAFB;border-bottom:1px solid #E5E7EB}.selector-entidad select{width:100%;padding:0.5rem;border:2px solid #E5E7EB;border-radius:6px}.user-info{padding:1rem 1.5rem;background:#F9FAFB;border-bottom:1px solid #E5E7EB;font-size:0.875rem}.user-email{color:#4F46E5;font-weight:600;margin-bottom:0.5rem}.btn-logout{padding:0.5rem 1rem;background:white;border:2px solid #E5E7EB;border-radius:6px;cursor:pointer;font-size:0.875rem;width:100%}.nav-items{flex:1;padding:1rem 0}.nav-item{width:100%;padding:1rem 1.5rem;border:none;background:none;display:flex;align-items:center;gap:0.75rem;cursor:pointer;color:#4B5563;font-size:1rem;border-left:3px solid transparent;text-align:left}.nav-item:hover:not(:disabled){background:#F3F4F6;color:#4F46E5}.nav-item.activo{background:rgba(79,70,229,0.1);color:#4F46E5;font-weight:600;border-left-color:#4F46E5}.nav-item:disabled{opacity:0.4;cursor:not-allowed}.main-content{flex:1;padding:2rem;overflow-y:auto;background:#F9FAFB}.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;flex-wrap:wrap;gap:1rem}.page-header h1{font-size:2rem;font-weight:800;color:#111827}.card{background:white;border-radius:12px;padding:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:1.5rem}.card h3{font-size:1.25rem;font-weight:700;color:#111827;margin-bottom:1rem}.card h4{font-size:1.1rem;font-weight:600;color:#374151;margin-bottom:0.5rem}.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.5rem}.stat-card{background:white;border-radius:12px;padding:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);border-left:4px solid #4F46E5}.stat-label{font-size:0.875rem;color:#6B7280;margin-bottom:0.5rem;text-transform:uppercase;font-weight:600}.stat-value{font-size:2.5rem;font-weight:800;color:#111827}.semaforo{display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;border-radius:8px;font-size:0.875rem;font-weight:600}.semaforo.critico{background:#FEE2E2;color:#991B1B}.semaforo.precaucion{background:#FEF3C7;color:#92400E}.semaforo.optimo{background:#D1FAE5;color:#065F46}.tabla{width:100%;border-collapse:collapse}.tabla th{background:#F9FAFB;padding:1rem;text-align:left;font-weight:700;color:#374151;font-size:0.875rem}.tabla td{padding:1rem;border-top:1px solid #E5E7EB}.tabla tr:hover{background:#F9FAFB}.badge{display:inline-block;padding:0.25rem 0.75rem;border-radius:12px;font-size:0.75rem;font-weight:700}.empty-state{text-align:center;padding:4rem 2rem;color:#6B7280}.empty-state h3{font-size:1.5rem;color:#111827;margin:1rem 0}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;padding:1rem}.modal{background:white;border-radius:16px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)}.modal-header{padding:1.5rem;border-bottom:1px solid #E5E7EB;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#4F46E5 0%,#7C3AED 100%);color:white;border-radius:16px 16px 0 0}.modal-header h2{font-size:1.5rem;font-weight:700}.btn-cerrar{background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:6px;cursor:pointer;font-size:1.5rem;line-height:1}.modal-body{padding:1.5rem}.form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}.btn-group{display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap}@media print{
  .sidebar,.page-header button,.btn-primary,.btn-secondary,.btn-edit,.btn-logout,.nav-items,.btn-cerrar,.modal-overlay{display:none!important}
  .app-container{display:block!important;max-width:100%!important}
  .main-content{padding:0.5rem!important;max-width:100%!important}
  .modal{position:relative!important;max-width:100%!important;width:100%!important;max-height:none!important;overflow:visible!important;box-shadow:none!important;margin:0!important;padding:0!important}
  .modal-header{border-bottom:2px solid #000!important;padding-bottom:0.5rem!important;page-break-after:avoid!important}
  .modal-body{overflow:visible!important;max-height:none!important}
  .card,table,tr,td,th,h3,h4{page-break-inside:avoid!important}
  h2,h3,h4,h5{page-break-after:avoid!important}
  table{width:100%!important;font-size:0.75rem!important;border-collapse:collapse!important}
  th,td{padding:0.3rem 0.4rem!important;border:1px solid #ddd!important}
  .card h3{font-size:1rem!important;margin-bottom:0.5rem!important}
  *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;color-adjust:exact!important}
  @page{margin:1cm!important}
}@media(max-width:768px){.sidebar{width:100%}.app-container{flex-direction:column}.grid{grid-template-columns:1fr}.form-row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">





const {useState,useEffect}=React;
const firebaseConfig={apiKey:"AIzaSyAudtZnoZuRtbEDJ8Am-7XgDBDsqTTdU68",authDomain:"plan-estrategico-50ab9.firebaseapp.com",projectId:"plan-estrategico-50ab9",storageBucket:"plan-estrategico-50ab9.firebasestorage.app",messagingSenderId:"708927732803",appId:"1:708927732803:web:b55ff91c7649e93cf0e8f6"};
if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
const imprimirInforme=()=>{window.print();};

const migrarDatosACompartido=async(uid,prefijo)=>{
  try{
    const rutaVieja=db.collection(prefijo+'_usuarios').doc(uid).collection(prefijo+'_entidades');
    const rutaNueva=db.collection(prefijo+'_datos');
    const snapViejo=await rutaVieja.get();
    if(snapViejo.empty)return;
    for(const entDoc of snapViejo.docs){
      const nuevaEntRef=rutaNueva.doc(entDoc.id);
      await nuevaEntRef.set(entDoc.data());
      for(const sub of ['ejes','objetivos','indicadores','seguimientos','plan_operativo']){
        const subSnap=await rutaVieja.doc(entDoc.id).collection(sub).get();
        for(const subDoc of subSnap.docs){
          await nuevaEntRef.collection(sub).doc(subDoc.id).set(subDoc.data());
        }
      }
    }
  }catch(e){}
};
const App=()=>{
  const[user,setUser]=useState(null);
  const[userRol,setUserRol]=useState(null);
  const[loading,setLoading]=useState(true);
  useEffect(()=>{
    const unsub=auth.onAuthStateChanged(async(u)=>{
      setUser(u);
      if(u){
        await migrarDatosACompartido(u.uid,'coosanroque');
        const doc=await db.collection('coosanroque_usuarios').doc(u.uid).get();
        if(doc.exists)setUserRol(doc.data().rol||'admin');
        else setUserRol('admin');
      }else{setUserRol(null);}
      setLoading(false);
    });
    return()=>unsub();
  },[]);
  if(loading)return <div className="loading">â³ Cargando...</div>;
  if(!user)return <AuthScreen/>;
  return <MainApp user={user} userRol={userRol}/>;
};
const AuthScreen=()=>{const[isLogin,setIsLogin]=useState(true);const[email,setEmail]=useState('');const[password,setPassword]=useState('');const[error,setError]=useState('');const[loading,setLoading]=useState(false);const handleSubmit=async(e)=>{e.preventDefault();setError('');setLoading(true);try{if(isLogin)await auth.signInWithEmailAndPassword(email,password);else await auth.createUserWithEmailAndPassword(email,password);}catch(err){setError(err.message);}finally{setLoading(false);}};return(<div className="auth-container"><div className="auth-box"><div className="auth-header"><h1>ğŸ¯ PlaneaciÃ³n EstratÃ©gica</h1><p>{isLogin?'Inicia sesiÃ³n':'Crea tu cuenta'}</p></div>{error&&<div className="error-message">âš ï¸ {error}</div>}<form onSubmit={handleSubmit}><div className="form-group"><label>Email</label><input type="email" value={email} onChange={(e)=>setEmail(e.target.value)} required/></div><div className="form-group"><label>ContraseÃ±a</label><input type="password" value={password} onChange={(e)=>setPassword(e.target.value)} required/></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³':(isLogin?'ğŸ” Entrar':'ğŸ“ Crear Cuenta')}</button></form><div style={{textAlign:'center',fontSize:'0.875rem',color:'#6B7280'}}>{isLogin?'Â¿No tienes cuenta? ':'Â¿Ya tienes cuenta? '}<button onClick={()=>setIsLogin(!isLogin)} style={{background:'none',border:'none',color:'#4F46E5',fontWeight:600,cursor:'pointer',textDecoration:'underline'}}>{isLogin?'RegÃ­strate':'Inicia sesiÃ³n'}</button></div></div></div>);};
const MainApp=({user,userRol})=>{
  const isAdmin=userRol==='admin'||userRol===null;
  const[vista,setVista]=useState('entidades');
  const[entidades,setEntidades]=useState([]);
  const[entidadActiva,setEntidadActiva]=useState(null);
  const[datos,setDatos]=useState(null);
  useEffect(()=>{
    if(!user)return;
    const u=db.collection('coosanroque_datos').onSnapshot((s)=>{
      const ents=[];s.forEach((doc)=>ents.push({id:doc.id,...doc.data()}));
      setEntidades(ents);
      if(entidadActiva){const act=ents.find(e=>e.id===entidadActiva.id);if(act)setEntidadActiva(act);}
    });
    return()=>u();
  },[user]);
  useEffect(()=>{
    if(!entidadActiva||!user){setDatos(null);return;}
    const ref=db.collection('coosanroque_datos').doc(entidadActiva.id);
    const unsubs=[
      ref.collection('ejes').onSnapshot(s=>{const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));setDatos(p=>({...p,ejes:d}))}),
      ref.collection('objetivos').onSnapshot(s=>{const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));setDatos(p=>({...p,objetivos:d}))}),
      ref.collection('indicadores').onSnapshot(s=>{const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));setDatos(p=>({...p,indicadores:d}))}),
      ref.collection('seguimientos').onSnapshot(s=>{const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));setDatos(p=>({...p,seguimientos:d}))}),
    ];
    return()=>unsubs.forEach(u=>u());
  },[entidadActiva,user]);
  return(<div className="app-container">
    <nav className="sidebar">
      <div className="sidebar-header">
        <h2>COOSANROQUE</h2>
        <p style={{fontSize:'0.875rem',opacity:0.9}}>PlaneaciÃ³n EstratÃ©gica</p>
      </div>
      <div className="selector-entidad">
        <select value={entidadActiva?.id||''} onChange={(e)=>setEntidadActiva(entidades.find(en=>en.id===e.target.value)||null)}>
          <option value="">Seleccionar...</option>
          {entidades.map(e=><option key={e.id} value={e.id}>{e.nombre}</option>)}
        </select>
      </div>
      <div className="user-info">
        <div className="user-email">ğŸ‘¤ {user.email}</div>
        <div style={{fontSize:'0.75rem',padding:'0.2rem 0.5rem',borderRadius:'6px',display:'inline-block',background:isAdmin?'#EDE9FE':'#D1FAE5',color:isAdmin?'#6D28D9':'#065F46',fontWeight:700,margin:'0.25rem 0'}}>
          {isAdmin?'ğŸ”‘ Admin':'ğŸ“ Seguimiento'}
        </div>
        <button className="btn-logout" onClick={()=>{if(window.confirm('Â¿Cerrar sesiÃ³n?'))auth.signOut();}}>ğŸšª Cerrar</button>
      </div>
      <div className="nav-items">
        <button className={`nav-item ${vista==='entidades'?'activo':''}`} onClick={()=>setVista('entidades')}>ğŸ¢ Entidades</button>
        <button className={`nav-item ${vista==='config'?'activo':''}`} onClick={()=>setVista('config')} disabled={!entidadActiva}>ğŸ“‹ PlaneaciÃ³n</button>
        <button className={`nav-item ${vista==='seguimiento'?'activo':''}`} onClick={()=>setVista('seguimiento')} disabled={!entidadActiva}>ğŸ“ Seguimiento</button>
        <button className={`nav-item ${vista==='dashboard'?'activo':''}`} onClick={()=>setVista('dashboard')} disabled={!entidadActiva}>ğŸ“Š Dashboard</button>
        <button className={`nav-item ${vista==='poa'?'activo':''}`} onClick={()=>setVista('poa')} disabled={!entidadActiva}>ğŸ—“ï¸ Plan Operativo</button>
        {isAdmin&&<button className={`nav-item ${vista==='usuarios'?'activo':''}`} onClick={()=>setVista('usuarios')} disabled={!entidadActiva}>ğŸ‘¥ Usuarios</button>}
      </div>
    </nav>
    <main className="main-content">
      {vista==='entidades'&&<VistaEntidades user={user} entidades={entidades} entidadActiva={entidadActiva}/>}
      {vista==='config'&&<VistaConfig user={user} entidad={entidadActiva} datos={datos} isAdmin={isAdmin}/>}
      {vista==='seguimiento'&&<VistaSeguimiento user={user} entidad={entidadActiva} datos={datos}/>}
      {vista==='dashboard'&&<VistaDashboard entidad={entidadActiva} datos={datos}/>}
      {vista==='poa'&&<VistaPlanOperativo user={user} entidad={entidadActiva} datos={datos}/>}
      {isAdmin&&vista==='usuarios'&&<VistaUsuarios user={user} userRol={userRol} entidad={entidadActiva}/>}
    </main>
  </div>);
};
const VistaEntidades=({user,entidades,entidadActiva})=>{const[modal,setModal]=useState(null);const[form,setForm]=useState({});const[itemEdit,setItemEdit]=useState(null);const[loading,setLoading]=useState(false);const guardar=async(e)=>{e.preventDefault();setLoading(true);try{const scoreConfig={critico:{min:0,max:parseFloat(form.criticoMax||60),color:'#DC2626',label:'CrÃ­tico'},precaucion:{min:parseFloat(form.precaucionMin||61),max:parseFloat(form.precaucionMax||85),color:'#F59E0B',label:'PrecauciÃ³n'},optimo:{min:parseFloat(form.optimoMin||86),max:100,color:'#059669',label:'Ã“ptimo'}};const data={nombre:form.nombre,nit:form.nit,periodo:form.periodo,vision:form.vision||'',scoreConfig};if(itemEdit){await db.collection('coosanroque_datos').doc(itemEdit.id).update(data);}else{await db.collection('coosanroque_datos').add({...data,createdAt:firebase.firestore.FieldValue.serverTimestamp()});}setModal(null);setForm({});setItemEdit(null);}catch(error){alert('Error: '+error.message);}finally{setLoading(false);}};const eliminar=async(id)=>{if(!window.confirm('Â¿Eliminar entidad y todos sus datos?'))return;try{await db.collection('coosanroque_datos').doc(id).delete();}catch(error){alert('Error: '+error.message);}};const editarEntidad=(ent)=>{setItemEdit(ent);setForm({nombre:ent.nombre,nit:ent.nit,periodo:ent.periodo,vision:ent.vision||'',criticoMax:ent.scoreConfig?.critico?.max||60,precaucionMin:ent.scoreConfig?.precaucion?.min||61,precaucionMax:ent.scoreConfig?.precaucion?.max||85,optimoMin:ent.scoreConfig?.optimo?.min||86});setModal('entidad');};return(<div><div className="page-header"><h1>Mis Entidades</h1><button className="btn-primary" style={{width:'auto'}} onClick={()=>{setItemEdit(null);setForm({nombre:'',nit:'',periodo:'',vision:'',criticoMax:'60',precaucionMin:'61',precaucionMax:'85',optimoMin:'86'});setModal('entidad');}}>+ Nueva Entidad</button></div><div className="grid">{entidades.length===0?(<div className="empty-state"><h3>ğŸ¢ No hay entidades</h3><p>Crea tu primera entidad</p></div>):(entidades.map(ent=>(<div key={ent.id} className="card" style={{borderLeft:entidadActiva?.id===ent.id?'4px solid #4F46E5':'4px solid transparent'}}><h3>{ent.nombre}</h3><p style={{color:'#6B7280',marginBottom:'0.5rem'}}>NIT: {ent.nit}</p><div className="badge" style={{background:'#4F46E5',color:'white',marginBottom:'0.5rem'}}>{ent.periodo}</div>{ent.vision&&<p style={{color:'#4F46E5',fontSize:'0.875rem',marginBottom:'0.5rem'}}>ğŸ¯ {ent.vision}</p>}{ent.scoreConfig&&(<p style={{color:'#059669',fontSize:'0.75rem',marginTop:'0.5rem'}}>Score: 0-{ent.scoreConfig.critico.max}% ğŸ”´ | {ent.scoreConfig.precaucion.min}-{ent.scoreConfig.precaucion.max}% ğŸŸ¡ | {ent.scoreConfig.optimo.min}%+ ğŸŸ¢</p>)}<div className="btn-group"><button className="btn-edit" onClick={()=>editarEntidad(ent)}>âœï¸ Editar</button><button className="btn-secondary" onClick={()=>eliminar(ent.id)}>ğŸ—‘ï¸ Eliminar</button></div></div>)))}</div>{modal==='entidad'&&(<div className="modal-overlay" onClick={()=>setModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h2>{itemEdit?'Editar':'Nueva'} Entidad</h2><button className="btn-cerrar" onClick={()=>setModal(null)}>Ã—</button></div><div className="modal-body"><form onSubmit={guardar}><div className="form-group"><label>Nombre *</label><input type="text" value={form.nombre} onChange={e=>setForm({...form,nombre:e.target.value})} required/></div><div className="form-group"><label>NIT *</label><input type="text" value={form.nit} onChange={e=>setForm({...form,nit:e.target.value})} required/></div><div className="form-group"><label>Periodo *</label><input type="text" value={form.periodo} onChange={e=>setForm({...form,periodo:e.target.value})} required placeholder="2025-2027"/></div><div className="form-group"><label>VisiÃ³n</label><textarea value={form.vision} onChange={e=>setForm({...form,vision:e.target.value})} rows={3}/></div><div className="card" style={{background:'#FEF3C7',marginBottom:'1rem'}}><h4 style={{color:'#92400E',marginBottom:'0.5rem'}}>âš™ï¸ ConfiguraciÃ³n de Score (Global)</h4><div className="form-row"><div className="form-group"><label>ğŸ”´ CrÃ­tico: 0% hasta</label><input type="number" value={form.criticoMax} onChange={e=>setForm({...form,criticoMax:e.target.value})} required/></div><div className="form-group"><label>ğŸŸ¡ PrecauciÃ³n: desde</label><input type="number" value={form.precaucionMin} onChange={e=>setForm({...form,precaucionMin:e.target.value})} required/></div></div><div className="form-row"><div className="form-group"><label>ğŸŸ¡ PrecauciÃ³n: hasta</label><input type="number" value={form.precaucionMax} onChange={e=>setForm({...form,precaucionMax:e.target.value})} required/></div><div className="form-group"><label>ğŸŸ¢ Ã“ptimo: desde</label><input type="number" value={form.optimoMin} onChange={e=>setForm({...form,optimoMin:e.target.value})} required/></div></div><small style={{color:'#92400E'}}>Este score se aplicarÃ¡ a TODOS los indicadores de esta entidad</small></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³ Guardando...':'ğŸ’¾ Guardar'}</button></form></div></div></div>)}</div>);};
const VistaDashboard=({entidad,datos})=>{
  const[anioSel,setAnioSel]=useState('');
  const[mesSel,setMesSel]=useState('');
  const[modalInforme,setModalInforme]=useState(false);

  if(!entidad||!datos)return <div className="empty-state"><h3>Selecciona una entidad</h3></div>;
  const{ejes=[],objetivos=[],indicadores=[],seguimientos=[]}=datos;

  const mesesOrden=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre','Semestral 1','Semestral 2','Anual'];
  const aniosDisp=[...new Set(seguimientos.map(s=>String(s.anio)))].sort();
  const mesesDisp=[...new Set(seguimientos.filter(s=>!anioSel||String(s.anio)===anioSel).map(s=>s.mes))].sort((a,b)=>mesesOrden.indexOf(a)-mesesOrden.indexOf(b));

  // Filtro: si hay aÃ±o y mes â†’ ese periodo; si solo aÃ±o â†’ Ãºltimo mes de ese aÃ±o; si nada â†’ Ãºltimo periodo global
  const periodos=[...new Set(seguimientos.map(s=>s.mes+'|'+s.anio))].sort((a,b)=>{
    const[mA,aA]=a.split('|');const[mB,aB]=b.split('|');
    if(aA!==aB)return parseInt(aA)-parseInt(aB);
    return mesesOrden.indexOf(mA)-mesesOrden.indexOf(mB);
  });
  const ultimoPeriodo=periodos[periodos.length-1];
  const[ultMes,ultAnio]=ultimoPeriodo?ultimoPeriodo.split('|'):['',''];

  const filtroMes=mesSel||ultMes;
  const filtroAnio=anioSel||ultAnio;
  const segsFiltrados=seguimientos.filter(s=>String(s.anio)===String(filtroAnio)&&s.mes===filtroMes);
  const periodoLabel=filtroMes&&filtroAnio?(filtroMes+' '+filtroAnio):'Sin datos';

  const porScore={critico:0,precaucion:0,optimo:0,sin_meta:0};
  segsFiltrados.forEach(s=>{if(s.score&&porScore[s.score]!==undefined)porScore[s.score]++;});

  const indicadoresConEstado=indicadores.map(ind=>{
    // Para el estado: usar el registro del periodo seleccionado, o el mÃ¡s reciente si no hay
    const segPeriodo=segsFiltrados.find(s=>s.indicadorId===ind.id);
    const segReciente=seguimientos.filter(s=>s.indicadorId===ind.id).sort((a,b)=>{
      if(a.anio!==b.anio)return parseInt(b.anio)-parseInt(a.anio);
      return mesesOrden.indexOf(b.mes)-mesesOrden.indexOf(a.mes);
    })[0];
    const ultSeg=segPeriodo||segReciente;
    const obj=objetivos.find(o=>o.id===ind.objetivoId);
    const eje=ejes.find(e=>e.id===obj?.ejeId);
    return{...ind,ultimoSeguimiento:ultSeg,enPeriodo:!!segPeriodo,objetivo:obj,eje:eje};
  });

  return(<div>
    <div className="page-header">
      <div>
        <h1>Dashboard - {entidad.nombre}</h1>
        <p style={{color:'#6B7280',fontSize:'0.875rem'}}>{entidad.periodo}</p>
      </div>
      <button className="btn-primary" style={{width:'auto'}} onClick={()=>setModalInforme(true)}>ğŸ–¨ï¸ Imprimir Informe</button>
    </div>

    <div className="card" style={{marginBottom:'1rem'}}>
      <div style={{display:'flex',gap:'1rem',alignItems:'flex-end',flexWrap:'wrap'}}>
        <div className="form-group" style={{margin:0,minWidth:'140px'}}>
          <label style={{fontSize:'0.85rem',fontWeight:600}}>AÃ±o</label>
          <select value={anioSel} onChange={e=>{setAnioSel(e.target.value);setMesSel('');}}
            style={{padding:'0.4rem 0.5rem',border:'2px solid #E5E7EB',borderRadius:'8px',fontSize:'0.9rem',width:'100%'}}>
            <option value="">Ãšltimo disponible</option>
            {aniosDisp.map(a=><option key={a} value={a}>{a}</option>)}
          </select>
        </div>
        <div className="form-group" style={{margin:0,minWidth:'160px'}}>
          <label style={{fontSize:'0.85rem',fontWeight:600}}>Mes / PerÃ­odo</label>
          <select value={mesSel} onChange={e=>setMesSel(e.target.value)}
            style={{padding:'0.4rem 0.5rem',border:'2px solid #E5E7EB',borderRadius:'8px',fontSize:'0.9rem',width:'100%'}}>
            <option value="">Ãšltimo disponible</option>
            {mesesDisp.map(m=><option key={m} value={m}>{m}</option>)}
          </select>
        </div>
        <div style={{paddingBottom:'0.25rem'}}>
          <span style={{background:'#EEF2FF',color:'#4F46E5',padding:'0.4rem 0.75rem',borderRadius:'8px',fontWeight:700,fontSize:'0.875rem'}}>
            ğŸ“… Mostrando: {periodoLabel}
          </span>
        </div>
        {(anioSel||mesSel)&&<button onClick={()=>{setAnioSel('');setMesSel('');}} style={{padding:'0.4rem 0.75rem',border:'1px solid #E5E7EB',borderRadius:'8px',background:'white',cursor:'pointer',fontSize:'0.85rem'}}>âœ• Limpiar</button>}
      </div>
    </div>

    <div className="grid">
      <div className="stat-card"><div className="stat-label">Ejes</div><div className="stat-value">{ejes.length}</div></div>
      <div className="stat-card"><div className="stat-label">Indicadores</div><div className="stat-value">{indicadores.length}</div></div>
      <div className="stat-card" style={{borderLeftColor:'#059669'}}><div className="stat-label">ğŸŸ¢ Ã“ptimos</div><div className="stat-value">{porScore.optimo}</div></div>
      <div className="stat-card" style={{borderLeftColor:'#F59E0B'}}><div className="stat-label">ğŸŸ¡ PrecauciÃ³n</div><div className="stat-value">{porScore.precaucion}</div></div>
      <div className="stat-card" style={{borderLeftColor:'#DC2626'}}><div className="stat-label">ğŸ”´ CrÃ­ticos</div><div className="stat-value">{porScore.critico}</div></div>
    </div>

    {indicadores.length>0&&<div className="card">
      <h3>ğŸ“Š Estado de Indicadores â€” {periodoLabel}</h3>
      <table className="tabla">
        <thead><tr><th>Eje</th><th>Objetivo</th><th>Indicador</th><th>Meta</th><th>Avance</th><th>Rendimiento</th><th>Estado</th></tr></thead>
        <tbody>{indicadoresConEstado.map(ind=>{
          const s=ind.ultimoSeguimiento;
          const sc={optimo:{bg:'#D1FAE5',c:'#065F46',icon:'ğŸŸ¢'},precaucion:{bg:'#FEF3C7',c:'#92400E',icon:'ğŸŸ¡'},critico:{bg:'#FEE2E2',c:'#991B1B',icon:'ğŸ”´'},sin_meta:{bg:'#F3F4F6',c:'#6B7280',icon:'âšª'}}[s?.score||'sin_meta']||{bg:'#F3F4F6',c:'#6B7280',icon:'â€”'};
          return(<tr key={ind.id} style={{opacity:ind.enPeriodo||!s?1:0.7}}>
            <td><div className="badge" style={{background:ind.eje?.color||'#6B7280',color:'white',padding:'0.2rem 0.5rem',borderRadius:'6px',fontSize:'0.75rem'}}>{ind.eje?.nombre||'-'}</div></td>
            <td style={{fontSize:'0.8rem',color:'#6B7280',maxWidth:'120px'}}>{ind.objetivo?.nombre}</td>
            <td><strong>{ind.nombre}</strong>{!ind.enPeriodo&&s&&<span style={{fontSize:'0.7rem',color:'#9CA3AF',marginLeft:'0.3rem'}}>(Ãºltimo: {s.mes} {s.anio})</span>}</td>
            <td>{s?(s.metaAnual||ind.meta)+' '+(ind.unidad||''):'-'}</td>
            <td>{s?s.avance+' '+(ind.unidad||''):'-'}</td>
            <td>{s?<strong>{(s.rendimiento||0).toFixed(1)}%</strong>:'-'}</td>
            <td>{s?<span style={{padding:'0.2rem 0.5rem',borderRadius:'6px',fontSize:'0.8rem',fontWeight:700,background:sc.bg,color:sc.c}}>{sc.icon} {s.score==='optimo'?'Ã“ptimo':s.score==='precaucion'?'PrecauciÃ³n':s.score==='critico'?'CrÃ­tico':'Sin meta'}</span>:'-'}</td>
          </tr>);
        })}</tbody>
      </table>
    </div>}

    {modalInforme&&<ModalImpresionDashboard entidad={entidad} datos={datos} periodo={periodoLabel} onClose={()=>setModalInforme(false)}/>}
  </div>);
};
const VistaConfig=({user,entidad,datos,isAdmin})=>{const[modal,setModal]=useState(null);const[form,setForm]=useState({});const[itemEdit,setItemEdit]=useState(null);const[loading,setLoading]=useState(false);if(!entidad||!datos)return <div className="empty-state"><h3>Selecciona una entidad</h3></div>;const{ejes=[],objetivos=[],indicadores=[]}=datos;const ref=db.collection('coosanroque_datos').doc(entidad.id);const scoreConfig=entidad.scoreConfig||{critico:{min:0,max:60},precaucion:{min:61,max:85},optimo:{min:86,max:100}};const guardarEje=async(e)=>{e.preventDefault();setLoading(true);try{if(itemEdit){await ref.collection('ejes').doc(itemEdit.id).update(form);}else{await ref.collection('ejes').add(form);}setModal(null);setForm({});setItemEdit(null);}catch(error){alert('Error: '+error.message);}finally{setLoading(false);}};const guardarObjetivo=async(e)=>{e.preventDefault();setLoading(true);try{if(itemEdit){await ref.collection('objetivos').doc(itemEdit.id).update(form);}else{await ref.collection('objetivos').add(form);}setModal(null);setForm({});setItemEdit(null);}catch(error){alert('Error: '+error.message);}finally{setLoading(false);}};const guardarIndicador=async(e)=>{
  e.preventDefault();
  setLoading(true);
  try{
    const metasPorAnio={};
    if(form.anios){
      form.anios.split(',').forEach(a=>{
        const anio=a.trim();
        if(anio)metasPorAnio[anio]=parseFloat(form[`meta_${anio}`]||form.meta);
      });
    }
    const updateData={
      objetivoId:form.objetivoId,
      nombre:form.nombre,
      tipo:form.tipo,
      periodicidad:form.periodicidad,
      meta:parseFloat(form.meta),
      unidad:form.unidad,
      estrategia:form.estrategia||'',
      metasPorAnio:metasPorAnio
    };
    if(itemEdit){
      console.log('Actualizando indicador',itemEdit.id,'con:',updateData);
      updateData.updatedAt=firebase.firestore.FieldValue.serverTimestamp();
      await ref.collection('indicadores').doc(itemEdit.id).update(updateData);
      console.log('ActualizaciÃ³n exitosa');
    }else{
      await ref.collection('indicadores').add(updateData);
    }
    setModal(null);
    setForm({});
    setItemEdit(null);
  }catch(error){
    console.error('Error:',error);
    alert('Error: '+error.message);
  }finally{
    setLoading(false);
  }
};const eliminar=async(coleccion,id)=>{if(!window.confirm('Â¿Eliminar?'))return;try{await ref.collection(coleccion).doc(id).delete();}catch(error){alert('Error: '+error.message);}};const editarEje=(eje)=>{setItemEdit(eje);setForm({nombre:eje.nombre,color:eje.color});setModal('eje');};const editarObjetivo=(obj)=>{setItemEdit(obj);setForm({ejeId:obj.ejeId,nombre:obj.nombre});setModal('objetivo');};const editarIndicador=(ind)=>{setItemEdit(ind);const anios=ind.metasPorAnio?Object.keys(ind.metasPorAnio).join(','):'';const formData={objetivoId:ind.objetivoId,nombre:ind.nombre,tipo:ind.tipo,periodicidad:ind.periodicidad,meta:ind.meta,unidad:ind.unidad,estrategia:ind.estrategia||'',anios};if(ind.metasPorAnio){Object.entries(ind.metasPorAnio).forEach(([anio,meta])=>{formData[`meta_${anio}`]=meta;});}setForm(formData);setModal('indicador');};return(<div><div className="page-header"><h1>PlaneaciÃ³n - {entidad.nombre}</h1></div><div className="card"><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}><h3>Ejes EstratÃ©gicos ({ejes.length})</h3><button className="btn-primary" style={{width:'auto'}} onClick={()=>{setItemEdit(null);setForm({nombre:'',color:'#4F46E5'});setModal('eje');}}>+ Nuevo Eje</button></div>{ejes.length===0?<p style={{color:'#6B7280'}}>No hay ejes</p>:<div className="grid">{ejes.map(eje=>(<div key={eje.id} className="card" style={{borderLeft:`4px solid ${eje.color}`}}><h4>{eje.nombre}</h4><div className="btn-group"><button className="btn-edit" onClick={()=>editarEje(eje)}>âœï¸ Editar</button><button className="btn-secondary" onClick={()=>eliminar('ejes',eje.id)}>ğŸ—‘ï¸ Eliminar</button></div></div>))}</div>}</div><div className="card"><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}><h3>Objetivos ({objetivos.length})</h3><button className="btn-primary" style={{width:'auto'}} onClick={()=>{setItemEdit(null);setForm({ejeId:'',nombre:''});setModal('objetivo');}} disabled={ejes.length===0}>+ Nuevo Objetivo</button></div>{objetivos.length===0?<p style={{color:'#6B7280'}}>No hay objetivos</p>:objetivos.map(obj=>{const eje=ejes.find(e=>e.id===obj.ejeId);return(<div key={obj.id} className="card" style={{borderLeft:`4px solid ${eje?.color||'#6B7280'}`}}><div className="badge" style={{background:eje?.color,color:'white',marginBottom:'0.5rem'}}>{eje?.nombre||'Sin eje'}</div><p>{obj.nombre}</p><div className="btn-group"><button className="btn-edit" onClick={()=>editarObjetivo(obj)}>âœï¸ Editar</button><button className="btn-secondary" onClick={()=>eliminar('objetivos',obj.id)}>ğŸ—‘ï¸ Eliminar</button></div></div>);})}</div><div className="card"><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}><h3>Indicadores ({indicadores.length})</h3><button className="btn-primary" style={{width:'auto'}} onClick={()=>{setItemEdit(null);setForm({objetivoId:'',nombre:'',tipo:'ascendente',periodicidad:'Mensual',meta:'',unidad:'%',estrategia:'',anios:''});setModal('indicador');}} disabled={objetivos.length===0}>+ Nuevo Indicador</button></div>{indicadores.length===0?<p style={{color:'#6B7280'}}>No hay indicadores</p>:<div className="grid">{indicadores.map(ind=>{const obj=objetivos.find(o=>o.id===ind.objetivoId);const eje=ejes.find(e=>e.id===obj?.ejeId);return(<div key={ind.id} className="card" style={{borderLeft:`4px solid ${eje?.color||'#6B7280'}`}}><div className="badge" style={{background:eje?.color,color:'white',marginBottom:'0.5rem'}}>{eje?.nombre}</div><h4>{ind.nombre}</h4><p style={{color:'#6B7280',fontSize:'0.875rem',marginTop:'0.5rem'}}>Meta: {ind.meta} {ind.unidad} | {ind.tipo==='ascendente'?'ğŸ“ˆ':'ğŸ“‰'}</p>{ind.metasPorAnio&&Object.keys(ind.metasPorAnio).length>0&&(<p style={{color:'#4F46E5',fontSize:'0.75rem',marginTop:'0.25rem'}}>Metas: {Object.entries(ind.metasPorAnio).map(([a,m])=>`${a}:${m}`).join(', ')}</p>)}<div className="btn-group"><button className="btn-edit" onClick={()=>editarIndicador(ind)}>âœï¸ Editar</button><button className="btn-secondary" onClick={()=>eliminar('indicadores',ind.id)}>ğŸ—‘ï¸ Eliminar</button></div></div>);})}</div>}</div>{modal==='eje'&&(<div className="modal-overlay" onClick={()=>setModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h2>{itemEdit?'Editar':'Nuevo'} Eje</h2><button className="btn-cerrar" onClick={()=>setModal(null)}>Ã—</button></div><div className="modal-body"><form onSubmit={guardarEje}><div className="form-group"><label>Nombre *</label><input type="text" value={form.nombre} onChange={e=>setForm({...form,nombre:e.target.value})} required/></div><div className="form-group"><label>Color</label><input type="color" value={form.color} onChange={e=>setForm({...form,color:e.target.value})}/></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar'}</button></form></div></div></div>)}{modal==='objetivo'&&(<div className="modal-overlay" onClick={()=>setModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h2>{itemEdit?'Editar':'Nuevo'} Objetivo</h2><button className="btn-cerrar" onClick={()=>setModal(null)}>Ã—</button></div><div className="modal-body"><form onSubmit={guardarObjetivo}><div className="form-group"><label>Eje *</label><select value={form.ejeId} onChange={e=>setForm({...form,ejeId:e.target.value})} required><option value="">Seleccionar...</option>{ejes.map(e=><option key={e.id} value={e.id}>{e.nombre}</option>)}</select></div><div className="form-group"><label>Nombre *</label><textarea value={form.nombre} onChange={e=>setForm({...form,nombre:e.target.value})} required rows={3}/></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar'}</button></form></div></div></div>)}{modal==='indicador'&&(<div className="modal-overlay" onClick={()=>setModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h2>{itemEdit?'Editar':'Nuevo'} Indicador</h2><button className="btn-cerrar" onClick={()=>setModal(null)}>Ã—</button></div><div className="modal-body"><form onSubmit={guardarIndicador}><div className="form-group"><label>Objetivo *</label><select value={form.objetivoId} onChange={e=>setForm({...form,objetivoId:e.target.value})} required><option value="">Seleccionar...</option>{objetivos.map(obj=>{const eje=ejes.find(e=>e.id===obj.ejeId);return<option key={obj.id} value={obj.id}>[{eje?.nombre}] {obj.nombre}</option>;})}</select></div><div className="form-group"><label>Nombre *</label><input type="text" value={form.nombre} onChange={e=>setForm({...form,nombre:e.target.value})} required/></div><div className="form-row"><div className="form-group"><label>Tipo *</label><select value={form.tipo} onChange={e=>setForm({...form,tipo:e.target.value})} required><option value="ascendente">ğŸ“ˆ Ascendente</option><option value="descendente">ğŸ“‰ Descendente</option></select></div><div className="form-group"><label>Periodicidad *</label><select value={form.periodicidad} onChange={e=>setForm({...form,periodicidad:e.target.value})} required><option value="Mensual">Mensual</option><option value="Bimestral">Bimestral</option><option value="Trimestral">Trimestral</option></select></div></div><div className="form-row"><div className="form-group"><label>Meta Base *</label><input type="number" step="0.01" value={form.meta} onChange={e=>setForm({...form,meta:e.target.value})} required/></div><div className="form-group"><label>Unidad *</label><input type="text" value={form.unidad} onChange={e=>setForm({...form,unidad:e.target.value})} required placeholder="%"/></div></div><div className="form-group"><label>AÃ±os con Metas EspecÃ­ficas</label><input type="text" value={form.anios} onChange={e=>setForm({...form,anios:e.target.value})} placeholder="2025,2026,2027"/><small style={{color:'#6B7280',display:'block',marginTop:'0.25rem'}}>Separados por coma</small></div>{form.anios&&form.anios.split(',').map(a=>{const anio=a.trim();if(!anio)return null;return(<div key={anio} className="form-group"><label>Meta para {anio}</label><input type="number" step="0.01" value={form[`meta_${anio}`]||form.meta} onChange={e=>setForm({...form,[`meta_${anio}`]:e.target.value})}/></div>);})}<div className="form-group"><label>Estrategia</label><textarea value={form.estrategia} onChange={e=>setForm({...form,estrategia:e.target.value})} rows={3}/></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar'}</button></form></div></div></div>)}</div>);};
const VistaPlanOperativo=({user,entidad,datos})=>{
  const[vista,setVista]=useState('planes');
  const[planSel,setPlanSel]=useState(null);
  const[planes,setPlanes]=useState([]);
  const[actividades,setActividades]=useState([]);
  const[modalPlan,setModalPlan]=useState(false);
  const[modalActividad,setModalActividad]=useState(false);
  const[modalSeguimiento,setModalSeguimiento]=useState(null);
  const[modalScore,setModalScore]=useState(false);
  const[todasActividades,setTodasActividades]=useState([]);
  const[formPlan,setFormPlan]=useState({});
  const[formActividad,setFormActividad]=useState({});
  const[itemEdit,setItemEdit]=useState(null);
  const[loading,setLoading]=useState(false);
  
  
  
  useEffect(()=>{
    if(!entidad)return;
    const unsub=db.collection('coosanroque_datos').doc(entidad.id).collection('poa_actividades').onSnapshot(s=>{
      const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));
      setTodasActividades(d);
    });
    return()=>unsub();
  },[entidad]);
  useEffect(()=>{
    if(!entidad)return;
    const unsub=db.collection('coosanroque_datos').doc(entidad.id).collection('planes_operativos').onSnapshot(s=>{
      const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));
      d.sort((a,b)=>(b.anio||0)-(a.anio||0));
      setPlanes(d);
    });
    return()=>unsub();
  },[entidad]);
  
  useEffect(()=>{
    if(!entidad||!planSel)return;
    const unsub=db.collection('coosanroque_datos').doc(entidad.id).collection('poa_actividades').where('planId','==',planSel.id).onSnapshot(s=>{
      const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));
      d.sort((a,b)=>(a.fechaInicio||'').localeCompare(b.fechaInicio||''));
      setActividades(d);
    });
    return()=>unsub();
  },[entidad,planSel]);
  
  if(!entidad||!datos)return <div className="empty-state"><h3>Selecciona una entidad</h3></div>;
  const{ejes=[],objetivos=[]}=datos;
  
  const guardarPlan=async(e)=>{
    e.preventDefault();setLoading(true);
    try{
      const ref=db.collection('coosanroque_datos').doc(entidad.id).collection('planes_operativos');
      const data={...formPlan,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
      if(itemEdit){
        await ref.doc(itemEdit.id).update(data);
      }else{
        await ref.add({...data,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      }
      setModalPlan(false);setFormPlan({});setItemEdit(null);
    }catch(err){alert('Error: '+err.message);}
    finally{setLoading(false);}
  };
  
  const eliminarPlan=async(id)=>{
    if(!window.confirm('Â¿Eliminar plan y todas sus actividades?'))return;
    const batch=db.batch();
    batch.delete(db.collection('coosanroque_datos').doc(entidad.id).collection('planes_operativos').doc(id));
    const acts=await db.collection('coosanroque_datos').doc(entidad.id).collection('poa_actividades').where('planId','==',id).get();
    acts.forEach(doc=>batch.delete(doc.ref));
    await batch.commit();
  };
  
  const guardarActividad=async(e)=>{
    e.preventDefault();setLoading(true);
    try{
      const ref=db.collection('coosanroque_datos').doc(entidad.id).collection('poa_actividades');
      const data={
        ...formActividad,
        planId:planSel.id,
        estado:formActividad.estado||'Pendiente',
        updatedAt:firebase.firestore.FieldValue.serverTimestamp()
      };
      if(itemEdit){
        await ref.doc(itemEdit.id).update(data);
      }else{
        await ref.add({...data,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      }
      setModalActividad(false);setFormActividad({});setItemEdit(null);
    }catch(err){alert('Error: '+err.message);}
    finally{setLoading(false);}
  };
  
  const eliminarActividad=async(id)=>{
    if(!window.confirm('Â¿Eliminar?'))return;
    await db.collection('coosanroque_datos').doc(entidad.id).collection('poa_actividades').doc(id).delete();
  };
  
  const guardarSeguimiento=async(e)=>{
    e.preventDefault();setLoading(true);
    try{
      await db.collection('coosanroque_datos').doc(entidad.id).collection('poa_actividades').doc(modalSeguimiento.id).update({
        estado:modalSeguimiento.estado,
        observacionesSeguimiento:modalSeguimiento.observacionesSeguimiento,
        fechaCambioEstado:new Date().toISOString().split('T')[0]
      });
      setModalSeguimiento(null);
    }catch(err){alert('Error: '+err.message);}
    finally{setLoading(false);}
  };
  
  const estadoColor={
    'Pendiente':{bg:'#FEF3C7',c:'#92400E'},
    'En Proceso':{bg:'#DBEAFE',c:'#1E40AF'},
    'Completado':{bg:'#D1FAE5',c:'#065F46'},
    'Reprogramado':{bg:'#FEE2E2',c:'#991B1B'}
  };
  
  return(<div>
    <div className="page-header">
      <h1>ğŸ—“ï¸ Plan Operativo Anual</h1>
      {!planSel?
        <button className="btn-primary" style={{width:'auto'}} onClick={()=>{setFormPlan({anio:new Date().getFullYear().toString()});setItemEdit(null);setModalPlan(true);}}>+ Nuevo POA</button>
      :
        <div style={{display:'flex',gap:'0.5rem'}}>
          <button className={`btn-${vista==='actividades'?'primary':'secondary'}`} onClick={()=>setVista('actividades')} style={{width:'auto'}}>ğŸ“‹ Actividades</button>
          <button className={`btn-${vista==='seguimiento'?'primary':'secondary'}`} onClick={()=>setVista('seguimiento')} style={{width:'auto'}}>âœ… Seguimiento</button>
          <button className="btn-primary" onClick={()=>setModalScore(true)} style={{width:'auto',background:'#059669'}}>ğŸ“Š Avance</button>
          <button className="btn-secondary" onClick={()=>{setPlanSel(null);setVista('planes');}} style={{width:'auto'}}>â† Volver</button>
        </div>
      }
    </div>
    
    {!planSel?
    <div>
      <div className="card">
        <h3>Planes Operativos ({planes.length})</h3>
        {planes.length===0?<p style={{color:'#9CA3AF'}}>No hay planes. Crea el primero.</p>:
        <div style={{display:'grid',gap:'1rem'}}>
          {planes.map(plan=>{
            const actsPlan=todasActividades.filter(a=>a.planId===plan.id);
            const completadas=actsPlan.filter(a=>a.estado==='Completado').length;
            const total=actsPlan.length;
            const avance=total>0?Math.round((completadas/total)*100):0;
            const objs=objetivos.filter(o=>(plan.objetivosIds||[]).includes(o.id));
            return(<div key={plan.id} className="card" style={{padding:'1rem',background:'#F9FAFB',cursor:'pointer'}} onClick={()=>{setPlanSel(plan);setVista('actividades');}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
                <div style={{flex:1}}>
                  <h4 style={{margin:'0 0 0.5rem 0',color:'#111827'}}>{plan.nombre}</h4>
                  <p style={{margin:'0.25rem 0',fontSize:'0.85rem',color:'#6B7280'}}>ğŸ“… AÃ±o: {plan.anio}</p>
                  <p style={{margin:'0.25rem 0',fontSize:'0.85rem',color:'#6B7280'}}>ğŸ¯ Objetivos: {objs.length}</p>
                  <div style={{marginTop:'0.5rem'}}>
                    <div style={{display:'flex',justifyContent:'space-between',marginBottom:'0.25rem'}}>
                      <span style={{fontSize:'0.8rem',color:'#6B7280'}}>Avance:</span>
                      <span style={{fontSize:'0.85rem',fontWeight:700,color:avance>=100?'#059669':avance>=50?'#F59E0B':'#DC2626'}}>{avance}%</span>
                    </div>
                    <div style={{width:'100%',height:'6px',background:'#E5E7EB',borderRadius:'3px'}}>
                      <div style={{width:avance+'%',height:'100%',background:avance>=100?'#059669':avance>=50?'#F59E0B':'#DC2626'}}></div>
                    </div>
                  </div>
                  {objs.length>0&&<div style={{marginTop:'0.5rem',display:'flex',flexWrap:'wrap',gap:'0.25rem'}}>
                    {objs.map(obj=><span key={obj.id} style={{fontSize:'0.75rem',padding:'0.25rem 0.5rem',background:'#EEF2FF',color:'#4F46E5',borderRadius:'4px'}}>{obj.nombre}</span>)}
                  </div>}
                  {plan.descripcion&&<p style={{margin:'0.5rem 0 0 0',fontSize:'0.85rem',color:'#6B7280',fontStyle:'italic'}}>"{plan.descripcion}"</p>}
                </div>
                <div style={{display:'flex',gap:'0.3rem'}} onClick={e=>e.stopPropagation()}>
                  <button className="btn-edit" onClick={()=>{setFormPlan(plan);setItemEdit(plan);setModalPlan(true);}} style={{padding:'0.3rem 0.5rem',fontSize:'0.75rem'}}>âœï¸</button>
                  <button className="btn-secondary" onClick={()=>eliminarPlan(plan.id)} style={{padding:'0.3rem 0.5rem',fontSize:'0.75rem'}}>ğŸ—‘ï¸</button>
                </div>
              </div>
            </div>);
          })}
        </div>}
      </div>
    </div>
    :
    <div>
      <div className="card" style={{marginBottom:'1rem',background:'#EEF2FF'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <div>
            <h3 style={{margin:'0 0 0.25rem 0',color:'#4F46E5'}}>{planSel.nombre}</h3>
            <p style={{margin:0,fontSize:'0.85rem',color:'#6B7280'}}>ğŸ“… {planSel.anio} â€¢ ğŸ¯ {(planSel.objetivosIds||[]).length} objetivos â€¢ ğŸ“ {actividades.length} actividades</p>
          </div>
        </div>
      </div>
      
      {vista==='actividades'?
      <div className="card">
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}>
          <h3>Actividades ({actividades.length})</h3>
          <button className="btn-primary" style={{width:'auto'}} onClick={()=>{setFormActividad({});setItemEdit(null);setModalActividad(true);}}>+ Nueva Actividad</button>
        </div>
        {actividades.length===0?<p style={{color:'#9CA3AF'}}>Sin actividades</p>:
        <table className="tabla">
          <thead>
            <tr>
              <th>Actividad</th>
              <th>Tarea</th>
              <th>Responsable</th>
              <th>Fechas</th>
              <th>Estado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {actividades.map(act=>{
              const ec=estadoColor[act.estado]||estadoColor['Pendiente'];
              return(<tr key={act.id}>
                <td><strong>{act.actividad}</strong></td>
                <td style={{fontSize:'0.85rem',color:'#6B7280'}}>{act.tarea||'-'}</td>
                <td>{act.responsable}</td>
                <td style={{fontSize:'0.8rem'}}>{act.fechaInicio} â†’ {act.fechaFin||''}</td>
                <td><span style={{padding:'0.25rem 0.5rem',borderRadius:'6px',fontSize:'0.75rem',fontWeight:600,background:ec.bg,color:ec.c}}>{act.estado}</span></td>
                <td>
                  <div style={{display:'flex',gap:'0.3rem'}}>
                    <button className="btn-edit" onClick={()=>{setFormActividad(act);setItemEdit(act);setModalActividad(true);}} style={{padding:'0.3rem 0.5rem',fontSize:'0.75rem'}}>âœï¸</button>
                    <button className="btn-secondary" onClick={()=>eliminarActividad(act.id)} style={{padding:'0.3rem 0.5rem',fontSize:'0.75rem'}}>ğŸ—‘ï¸</button>
                  </div>
                </td>
              </tr>);
            })}
          </tbody>
        </table>}
      </div>
      :
      <div className="card">
        <h3>Seguimiento de Actividades</h3>
        {actividades.length===0?<p style={{color:'#9CA3AF'}}>Sin actividades</p>:
        <div style={{display:'grid',gap:'1rem'}}>
          {actividades.map(act=>{
            const ec=estadoColor[act.estado]||estadoColor['Pendiente'];
            return(<div key={act.id} className="card" style={{padding:'1rem',background:'#F9FAFB'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'0.5rem'}}>
                <div style={{flex:1}}>
                  <h4 style={{margin:'0 0 0.5rem 0',color:'#111827'}}>{act.actividad}</h4>
                  {act.tarea&&<p style={{margin:'0.25rem 0',fontSize:'0.85rem',color:'#6B7280'}}>ğŸ“‹ Tarea: {act.tarea}</p>}
                  <p style={{margin:'0.25rem 0',fontSize:'0.85rem',color:'#6B7280'}}>ğŸ‘¤ {act.responsable}</p>
                  <p style={{margin:'0.25rem 0',fontSize:'0.85rem',color:'#6B7280'}}>ğŸ“… {act.fechaInicio} â†’ {act.fechaFin||'-'}</p>
                  {act.observaciones&&<p style={{margin:'0.5rem 0',fontSize:'0.85rem',padding:'0.5rem',background:'white',borderRadius:'4px',borderLeft:'3px solid #4F46E5'}}>ğŸ“ {act.observaciones}</p>}
                  {act.observacionesSeguimiento&&<p style={{margin:'0.5rem 0',fontSize:'0.85rem',padding:'0.5rem',background:'#FEF3C7',borderRadius:'4px',borderLeft:'3px solid #F59E0B'}}>ğŸ’¬ Seguimiento: {act.observacionesSeguimiento}</p>}
                </div>
                <span style={{padding:'0.5rem 0.75rem',borderRadius:'6px',fontWeight:700,fontSize:'0.85rem',background:ec.bg,color:ec.c,whiteSpace:'nowrap'}}>{act.estado}</span>
              </div>
              <div style={{display:'flex',gap:'0.5rem',marginTop:'1rem',paddingTop:'1rem',borderTop:'1px solid #E5E7EB',flexWrap:'wrap'}}>
                <button onClick={()=>setModalSeguimiento({...act,estado:'Pendiente'})} style={{padding:'0.4rem 0.75rem',fontSize:'0.85rem',background:act.estado==='Pendiente'?'#FEF3C7':'white',border:'1px solid #F59E0B',borderRadius:'6px',cursor:'pointer',fontWeight:act.estado==='Pendiente'?700:400}}>â¸ï¸ Pendiente</button>
                <button onClick={()=>setModalSeguimiento({...act,estado:'En Proceso'})} style={{padding:'0.4rem 0.75rem',fontSize:'0.85rem',background:act.estado==='En Proceso'?'#DBEAFE':'white',border:'1px solid #3B82F6',borderRadius:'6px',cursor:'pointer',fontWeight:act.estado==='En Proceso'?700:400}}>ğŸ”„ En Proceso</button>
                <button onClick={()=>setModalSeguimiento({...act,estado:'Completado'})} style={{padding:'0.4rem 0.75rem',fontSize:'0.85rem',background:act.estado==='Completado'?'#D1FAE5':'white',border:'1px solid #059669',borderRadius:'6px',cursor:'pointer',fontWeight:act.estado==='Completado'?700:400}}>âœ… Completado</button>
                <button onClick={()=>setModalSeguimiento({...act,estado:'Reprogramado'})} style={{padding:'0.4rem 0.75rem',fontSize:'0.85rem',background:act.estado==='Reprogramado'?'#FEE2E2':'white',border:'1px solid #DC2626',borderRadius:'6px',cursor:'pointer',fontWeight:act.estado==='Reprogramado'?700:400}}>ğŸ” Reprogramar</button>
              </div>
            </div>);
          })}
        </div>}
      </div>}
    </div>}
    
    {modalPlan&&<div className="modal-overlay" onClick={()=>{setModalPlan(false);setItemEdit(null);}}>
      <div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:'700px'}}>
        <div className="modal-header">
          <h2>{itemEdit?'âœï¸ Editar':'ğŸ“ Nuevo'} Plan Operativo</h2>
          <button className="btn-cerrar" onClick={()=>{setModalPlan(false);setItemEdit(null);}}>Ã—</button>
        </div>
        <div className="modal-body">
          <form onSubmit={guardarPlan}>
            <div className="form-group">
              <label>Nombre del POA *</label>
              <input type="text" value={formPlan.nombre||''} onChange={e=>setFormPlan({...formPlan,nombre:e.target.value})} required placeholder="Ej: POA 2025"/>
            </div>
            <div className="form-row">
              <div className="form-group">
                <label>AÃ±o *</label>
                <select value={formPlan.anio||''} onChange={e=>setFormPlan({...formPlan,anio:e.target.value})} required>
                  <option value="">Seleccionar...</option>
                  {['2024','2025','2026','2027','2028'].map(a=><option key={a} value={a}>{a}</option>)}
                </select>
              </div>
            </div>
            <div className="form-group">
              <label>Objetivos EstratÃ©gicos *</label>
              <div style={{border:'1px solid #E5E7EB',borderRadius:'6px',padding:'0.5rem',maxHeight:'200px',overflow:'auto'}}>
                {objetivos.length===0?<p style={{color:'#9CA3AF',fontSize:'0.85rem',margin:0}}>No hay objetivos</p>:
                objetivos.map(obj=>{
                  const eje=ejes.find(e=>e.id===obj.ejeId);
                  return(<label key={obj.id} style={{display:'block',padding:'0.25rem',cursor:'pointer'}}>
                    <input type="checkbox" checked={(formPlan.objetivosIds||[]).includes(obj.id)} onChange={e=>{
                      const ids=formPlan.objetivosIds||[];
                      setFormPlan({...formPlan,objetivosIds:e.target.checked?[...ids,obj.id]:ids.filter(i=>i!==obj.id)});
                    }}/> <strong>[{eje?.nombre}]</strong> {obj.nombre}
                  </label>);
                })}
              </div>
            </div>
            <div className="form-group">
              <label>DescripciÃ³n</label>
              <textarea value={formPlan.descripcion||''} onChange={e=>setFormPlan({...formPlan,descripcion:e.target.value})} rows={2}/>
            </div>
            <button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar'}</button>
          </form>
        </div>
      </div>
    </div>}
    
    {modalActividad&&planSel&&<div className="modal-overlay" onClick={()=>{setModalActividad(false);setItemEdit(null);}}>
      <div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:'700px'}}>
        <div className="modal-header">
          <h2>{itemEdit?'âœï¸ Editar':'ğŸ“ Nueva'} Actividad</h2>
          <button className="btn-cerrar" onClick={()=>{setModalActividad(false);setItemEdit(null);}}>Ã—</button>
        </div>
        <div className="modal-body">
          <form onSubmit={guardarActividad}>
            <div className="form-group">
              <label>Actividad *</label>
              <input type="text" value={formActividad.actividad||''} onChange={e=>setFormActividad({...formActividad,actividad:e.target.value})} required placeholder="Nombre de la actividad"/>
            </div>
            <div className="form-group">
              <label>Tarea</label>
              <textarea value={formActividad.tarea||''} onChange={e=>setFormActividad({...formActividad,tarea:e.target.value})} rows={2} placeholder="DescripciÃ³n de la tarea"/>
            </div>
            <div className="form-group">
              <label>Responsable *</label>
              <input type="text" value={formActividad.responsable||''} onChange={e=>setFormActividad({...formActividad,responsable:e.target.value})} required/>
            </div>
            <div className="form-row">
              <div className="form-group">
                <label>Fecha Inicio *</label>
                <input type="date" value={formActividad.fechaInicio||''} onChange={e=>setFormActividad({...formActividad,fechaInicio:e.target.value})} required/>
              </div>
              <div className="form-group">
                <label>Fecha Fin</label>
                <input type="date" value={formActividad.fechaFin||''} onChange={e=>setFormActividad({...formActividad,fechaFin:e.target.value})}/>
              </div>
            </div>
            <div className="form-group">
              <label>Observaciones</label>
              <textarea value={formActividad.observaciones||''} onChange={e=>setFormActividad({...formActividad,observaciones:e.target.value})} rows={2}/>
            </div>
            <button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar'}</button>
          </form>
        </div>
      </div>
    </div>}
    
    {modalSeguimiento&&<div className="modal-overlay" onClick={()=>setModalSeguimiento(null)}>
      <div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:'600px'}}>
        <div className="modal-header">
          <h2>âœ… Actualizar Seguimiento</h2>
          <button className="btn-cerrar" onClick={()=>setModalSeguimiento(null)}>Ã—</button>
        </div>
        <div className="modal-body">
          <form onSubmit={guardarSeguimiento}>
            <div className="form-group">
              <label>Actividad</label>
              <input type="text" value={modalSeguimiento.actividad} disabled style={{background:'#F3F4F6'}}/>
            </div>
            <div className="form-group">
              <label>Nuevo Estado *</label>
              <select value={modalSeguimiento.estado} onChange={e=>setModalSeguimiento({...modalSeguimiento,estado:e.target.value})} required>
                <option value="Pendiente">â¸ï¸ Pendiente</option>
                <option value="En Proceso">ğŸ”„ En Proceso</option>
                <option value="Completado">âœ… Completado</option>
                <option value="Reprogramado">ğŸ” Reprogramado</option>
              </select>
            </div>
            <div className="form-group">
              <label>Observaciones del Seguimiento</label>
              <textarea value={modalSeguimiento.observacionesSeguimiento||''} onChange={e=>setModalSeguimiento({...modalSeguimiento,observacionesSeguimiento:e.target.value})} rows={3} placeholder="AÃ±ade notas sobre el cambio de estado..."/>
            </div>
            <button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar'}</button>
          </form>
        </div>
      </div>
    </div>}
    
    {modalScore&&planSel&&<div className="modal-overlay" onClick={()=>setModalScore(false)}>
      <div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:'900px',width:'95%'}}>
        <div className="modal-header">
          <h2>ğŸ“Š Informe de Avance - {planSel.nombre}</h2>
          <div style={{display:'flex',gap:'0.5rem'}}>
            <button className="btn-primary" style={{width:'auto'}} onClick={()=>window.print()}>ğŸ–¨ï¸ Imprimir</button>
            <button className="btn-cerrar" onClick={()=>setModalScore(false)}>Ã—</button>
          </div>
        </div>
        <div className="modal-body">
          <div style={{background:'#F9FAFB',padding:'1rem',borderRadius:'8px',marginBottom:'1.5rem'}}>
            <h3 style={{marginTop:0}}>Resumen</h3>
            <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:'1rem'}}>
              <div style={{textAlign:'center',padding:'1rem',background:'white',borderRadius:'6px'}}>
                <div style={{fontSize:'2rem',fontWeight:700,color:'#4F46E5'}}>{actividades.length}</div>
                <div style={{fontSize:'0.85rem',color:'#6B7280'}}>Total</div>
              </div>
              <div style={{textAlign:'center',padding:'1rem',background:'white',borderRadius:'6px'}}>
                <div style={{fontSize:'2rem',fontWeight:700,color:'#059669'}}>{actividades.filter(a=>a.estado==='Completado').length}</div>
                <div style={{fontSize:'0.85rem',color:'#6B7280'}}>âœ… Completadas</div>
              </div>
              <div style={{textAlign:'center',padding:'1rem',background:'white',borderRadius:'6px'}}>
                <div style={{fontSize:'2rem',fontWeight:700,color:'#3B82F6'}}>{actividades.filter(a=>a.estado==='En Proceso').length}</div>
                <div style={{fontSize:'0.85rem',color:'#6B7280'}}>ğŸ”„ En Proceso</div>
              </div>
              <div style={{textAlign:'center',padding:'1rem',background:'white',borderRadius:'6px'}}>
                <div style={{fontSize:'2rem',fontWeight:700,color:'#F59E0B'}}>{actividades.filter(a=>a.estado==='Pendiente').length}</div>
                <div style={{fontSize:'0.85rem',color:'#6B7280'}}>â¸ï¸ Pendientes</div>
              </div>
            </div>
          </div>
          <div style={{marginBottom:'2rem'}}>
            <h3>Avance Global</h3>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:'0.5rem'}}>
              <span style={{fontSize:'1.1rem',fontWeight:600}}>Cumplimiento</span>
              <span style={{fontSize:'2rem',fontWeight:700,color:(()=>{const av=actividades.length>0?Math.round((actividades.filter(a=>a.estado==='Completado').length/actividades.length)*100):0;return av>=100?'#059669':av>=50?'#F59E0B':'#DC2626';})()}}>
                {actividades.length>0?Math.round((actividades.filter(a=>a.estado==='Completado').length/actividades.length)*100):0}%
              </span>
            </div>
            <div style={{width:'100%',height:'30px',background:'#E5E7EB',borderRadius:'15px',overflow:'hidden'}}>
              <div style={{width:(actividades.length>0?Math.round((actividades.filter(a=>a.estado==='Completado').length/actividades.length)*100):0)+'%',height:'100%',background:(()=>{const av=actividades.length>0?Math.round((actividades.filter(a=>a.estado==='Completado').length/actividades.length)*100):0;return av>=100?'#059669':av>=50?'#F59E0B':'#DC2626';})(),display:'flex',alignItems:'center',justifyContent:'flex-end',paddingRight:'0.5rem',color:'white',fontWeight:700}}>{actividades.length>0?Math.round((actividades.filter(a=>a.estado==='Completado').length/actividades.length)*100):0}%</div>
            </div>
          </div>
          <div>
            <h3>Detalle por Estado</h3>
            {['Completado','En Proceso','Pendiente','Reprogramado'].map(estado=>{
              const acts=actividades.filter(a=>a.estado===estado);
              if(acts.length===0)return null;
              const cols={'Completado':{bg:'#D1FAE5',c:'#065F46'},'En Proceso':{bg:'#DBEAFE',c:'#1E40AF'},'Pendiente':{bg:'#FEF3C7',c:'#92400E'},'Reprogramado':{bg:'#FEE2E2',c:'#991B1B'}};
              const col=cols[estado];
              return(<div key={estado} style={{marginBottom:'1.5rem'}}>
                <h4 style={{padding:'0.5rem 1rem',background:col.bg,color:col.c,borderRadius:'6px',display:'inline-block'}}>{estado} ({acts.length})</h4>
                <table className="tabla" style={{fontSize:'0.85rem',marginTop:'0.5rem'}}>
                  <thead><tr><th>Actividad</th><th>Responsable</th><th>Fechas</th></tr></thead>
                  <tbody>{acts.map(act=>(<tr key={act.id}>
                    <td><strong>{act.actividad}</strong>{act.tarea&&<div style={{fontSize:'0.8rem',color:'#6B7280'}}>{act.tarea}</div>}</td>
                    <td>{act.responsable}</td>
                    <td style={{fontSize:'0.8rem'}}>{act.fechaInicio} â†’ {act.fechaFin||'-'}</td>
                  </tr>))}</tbody>
                </table>
              </div>);
            })}
          </div>
        </div>
      </div>
    </div>}

  </div>);
};

const VistaSeguimiento=({user,entidad,datos})=>{
  const[indicadorSel,setIndicadorSel]=useState(null);
  const[busquedaSeg,setBusquedaSeg]=useState('');
  const[segEdit,setSegEdit]=useState(null);
  const[modal,setModal]=useState(false);
  const[form,setForm]=useState({});
  const[loading,setLoading]=useState(false);
  const[seguimientos,setSeguimientos]=useState([]);

  useEffect(()=>{
    if(!entidad||!indicadorSel)return;
    const ref=db.collection('coosanroque_datos').doc(entidad.id).collection('seguimientos');
    const unsub=ref.where('indicadorId','==',indicadorSel).onSnapshot(s=>{
      const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));
      d.sort((a,b)=>{const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre','Semestral 1','Semestral 2','Anual'];return(a.anio-b.anio)||meses.indexOf(a.mes)-meses.indexOf(b.mes);});
      setSeguimientos(d);
    });
    return()=>unsub();
  },[entidad,indicadorSel]);

  if(!entidad||!datos)return <div className="empty-state"><h3>Selecciona entidad</h3></div>;
  const{ejes=[],objetivos=[],indicadores=[]}=datos;
  const indicador=indicadores.find(i=>i.id===indicadorSel);

  const calcScore=(avance,metaMes,tipo)=>{
    if(!metaMes||metaMes===0)return'sin_meta';
    const r=(avance/metaMes)*100;
    if(tipo==='descendente'){if(r<=100)return'optimo';if(r<=120)return'precaucion';return'critico';}
    if(r>=100)return'optimo';if(r>=70)return'precaucion';return'critico';
  };

  const guardar=async(e)=>{
    e.preventDefault();setLoading(true);
    try{
      const metaMes=parseFloat(form.metaMes||0);
      const avance=parseFloat(form.avance||0);
      const metaAnual=parseFloat(form.metaAnual||indicador?.meta||0);
      const rendimiento=metaMes>0?(avance/metaMes)*100:0;
      const score=calcScore(avance,metaMes,indicador?.tipo);
      const data={...form,metaMes,avance,metaAnual,rendimiento,score,indicadorId:indicadorSel};
      const ref=db.collection('coosanroque_datos').doc(entidad.id).collection('seguimientos');
      if(segEdit){await ref.doc(segEdit.id).update(data);}
      else{await ref.add({...data,createdAt:firebase.firestore.FieldValue.serverTimestamp()});}
      setModal(false);setForm({});setSegEdit(null);
    }catch(err){alert('Error: '+err.message);}
    finally{setLoading(false);}
  };

  const editarSeg=(s)=>{setSegEdit(s);setForm({...s});setModal(true);};

  const eliminarSeg=async(id)=>{
    if(!window.confirm('Â¿Eliminar este registro de seguimiento?'))return;
    await db.collection('coosanroque_datos').doc(entidad.id).collection('seguimientos').doc(id).delete();
  };

  const scoreColor={optimo:'#D1FAE5',precaucion:'#FEF3C7',critico:'#FEE2E2',sin_meta:'#F3F4F6'};
  const scoreIcon={optimo:'ğŸŸ¢',precaucion:'ğŸŸ¡',critico:'ğŸ”´',sin_meta:'âšª'};
  const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre','Semestral 1','Semestral 2','Anual'];

  const indicadoresFiltrados=indicadores.filter(i=>{
    const o=objetivos.find(x=>x.id===i.objetivoId);
    const ej=ejes.find(x=>x.id===o?.ejeId);
    return(i.nombre+' '+(ej?.nombre||'')).toLowerCase().includes(busquedaSeg.toLowerCase());
  });

  return(<div>
    <div className="page-header">
      <h1>ğŸ“‹ Seguimiento de Indicadores</h1>
      {indicadorSel&&<button className="btn-primary" style={{width:'auto'}}
        onClick={()=>{setSegEdit(null);setForm({mes:meses[new Date().getMonth()],anio:new Date().getFullYear().toString(),avance:'',metaMes:'',metaAnual:indicador?.meta||'',observaciones:''});setModal(true);}}>
        + Nuevo Registro
      </button>}
    </div>
    <div className="card">
      <div className="form-group">
        <label>Buscar Indicador</label>
        <input type="text" value={busquedaSeg} onChange={e=>setBusquedaSeg(e.target.value)} placeholder="Escribe para filtrar..." style={{marginBottom:'0.5rem'}}/>
        <select value={indicadorSel||''} onChange={e=>setIndicadorSel(e.target.value||null)}
          size={Math.min(6,indicadoresFiltrados.length+1)} style={{height:'auto',minHeight:'80px'}}>
          <option value="">-- Seleccionar indicador --</option>
          {indicadoresFiltrados.map(ind=>{
            const obj=objetivos.find(o=>o.id===ind.objetivoId);
            const eje=ejes.find(e=>e.id===obj?.ejeId);
            return<option key={ind.id} value={ind.id}>[{eje?.nombre}] {ind.nombre}</option>;
          })}
        </select>
      </div>
    </div>
    {!indicadorSel&&<div className="empty-state"><h3>Selecciona un indicador para ver su seguimiento</h3></div>}
    {indicador&&(<>
      <div className="card">
        <h3>{indicador.nombre}</h3>
        <p style={{color:'#6B7280',margin:'0.25rem 0'}}>{indicador.tipo==='ascendente'?'ğŸ“ˆ':'ğŸ“‰'} Meta anual: {indicador.meta} {indicador.unidad}</p>
        {indicador.metasPorAnio&&<div style={{fontSize:'0.8rem',color:'#4F46E5',marginTop:'0.5rem'}}>
          ğŸ“… Metas por aÃ±o: {Object.entries(indicador.metasPorAnio).map(([a,m])=>a+': '+m).join(' | ')}
        </div>}
      </div>
      <div className="card">
        <h3>Historial de Registros</h3>
        {seguimientos.length===0?<div className="empty-state" style={{padding:'1.5rem'}}><p>No hay registros. Click en + Nuevo Registro.</p></div>:
        <div style={{overflowX:'auto'}}>
          <table className="tabla">
            <thead><tr><th>PerÃ­odo</th><th>Meta Anual</th><th>Meta Mes</th><th>Avance</th><th>Rendimiento</th><th>Score</th><th>Obs.</th><th>Acciones</th></tr></thead>
            <tbody>{seguimientos.map(seg=>(
              <tr key={seg.id}>
                <td><strong>{seg.mes} {seg.anio}</strong></td>
                <td>{seg.metaAnual||indicador.meta} {indicador.unidad}</td>
                <td>{seg.metaMes} {indicador.unidad}</td>
                <td>{seg.avance} {indicador.unidad}</td>
                <td><strong>{seg.rendimiento.toFixed(2)}%</strong></td>
                <td><div className={'semaforo '+(seg.score||'sin_meta')}>{scoreIcon[seg.score||'sin_meta']}</div></td>
                <td style={{maxWidth:'120px',fontSize:'0.8rem',color:'#6B7280'}}>{seg.observaciones}</td>
                <td>
                  <div style={{display:'flex',gap:'0.3rem'}}>
                    <button className="btn-edit" onClick={()=>editarSeg(seg)}>âœï¸</button>
                    <button className="btn-secondary" style={{padding:'0.3rem 0.5rem',fontSize:'0.8rem'}} onClick={()=>eliminarSeg(seg.id)}>ğŸ—‘ï¸</button>
                  </div>
                </td>
              </tr>
            ))}</tbody>
          </table>
        </div>}
      </div>
    </>)}
    {modal&&indicador&&(<div className="modal-overlay" onClick={()=>{setModal(false);setSegEdit(null);}}>
      <div className="modal" onClick={e=>e.stopPropagation()}>
        <div className="modal-header">
          <h2>{segEdit?'âœï¸ Editar Registro':'Registrar Seguimiento'}</h2>
          <button className="btn-cerrar" onClick={()=>{setModal(false);setSegEdit(null);}}>Ã—</button>
        </div>
        <div className="modal-body">
          <div style={{background:'#EEF2FF',padding:'0.5rem 0.75rem',borderRadius:'6px',marginBottom:'0.75rem',fontSize:'0.875rem',color:'#4F46E5'}}>
            {indicador.nombre}
          </div>
          <form onSubmit={guardar}>
            <div className="form-row">
              <div className="form-group">
                <label>Mes *</label>
                <select value={form.mes||''} onChange={e=>setForm({...form,mes:e.target.value})} required>
                  <option value="">Seleccionar...</option>
                  {meses.map(m=><option key={m} value={m}>{m}</option>)}
                </select>
              </div>
              <div className="form-group">
                <label>AÃ±o *</label>
                <select value={form.anio||new Date().getFullYear()} onChange={e=>setForm({...form,anio:e.target.value})} required>
                  {['2024','2025','2026','2027','2028'].map(a=><option key={a} value={a}>{a}</option>)}
                </select>
              </div>
            </div>
            <div className="form-row">
              <div className="form-group">
                <label>Meta Anual ({indicador.unidad})</label>
                <input type="number" value={form.metaAnual||indicador.meta||''} onChange={e=>setForm({...form,metaAnual:e.target.value})}/>
              </div>
              <div className="form-group">
                <label>Meta del Mes ({indicador.unidad}) *</label>
                <input type="number" value={form.metaMes||''} onChange={e=>setForm({...form,metaMes:e.target.value})} required/>
              </div>
            </div>
            <div className="form-group">
              <label>Avance Real ({indicador.unidad}) *</label>
              <input type="number" value={form.avance||''} onChange={e=>setForm({...form,avance:e.target.value})} required/>
            </div>
            <div className="form-group">
              <label>Observaciones</label>
              <textarea value={form.observaciones||''} onChange={e=>setForm({...form,observaciones:e.target.value})} rows={3}/>
            </div>
            <button type="submit" className="btn-primary" disabled={loading}>
              {loading?'â³...':(segEdit?'ğŸ’¾ Actualizar':'ğŸ’¾ Guardar Actividad')}
            </button>
          </form>
        </div>
      </div>
    </div>)}
  </div>);
};const VistaUsuarios=({user,userRol,entidad})=>{
  const[usuarios,setUsuarios]=useState([]);
  const[modal,setModal]=useState(false);
  const[form,setForm]=useState({email:'',password:'',rol:'seguimiento',nombre:''});
  const[usuarioEdit,setUsuarioEdit]=useState(null);
  const[loading,setLoading]=useState(false);
  const[mensaje,setMensaje]=useState({texto:'',tipo:''});

  useEffect(()=>{
    if(!entidad)return;
    const unsub=db.collection('coosanroque_usuarios').onSnapshot(s=>{
      const d=[];
      s.forEach(doc=>d.push({id:doc.id,...doc.data()}));
      d.sort((a,b)=>(a.nombre||a.email).localeCompare(b.nombre||b.email));
      setUsuarios(d);
    });
    return()=>unsub();
  },[entidad]);

  const crearUsuario=async(e)=>{
    e.preventDefault();setLoading(true);setMensaje({texto:'',tipo:''});
    try{
      if(usuarioEdit){
        await db.collection('coosanroque_usuarios').doc(usuarioEdit.id).update({nombre:form.nombre||form.email,rol:form.rol});
        setMensaje({texto:'Actualizado.',tipo:'ok'});
        setModal(false);setForm({email:'',password:'',rol:'seguimiento',nombre:''});setUsuarioEdit(null);
        setLoading(false);return;
      }
      const existing=await db.collection('coosanroque_usuarios').where('email','==',form.email).get();
      if(!existing.empty){
        await existing.docs[0].ref.update({nombre:form.nombre||form.email,rol:form.rol});
        setMensaje({texto:'Usuario actualizado.',tipo:'ok'});
      }else{
        const _app=firebase.initializeApp(firebase.app().options,'sec'+Date.now());
        const _auth=_app.auth();
        const cred=await _auth.createUserWithEmailAndPassword(form.email,form.password);
        await db.collection('coosanroque_usuarios').doc(cred.user.uid).set({
          email:form.email,nombre:form.nombre||form.email,rol:form.rol,
          entidadId:'general',creadoPor:user.uid,
          createdAt:firebase.firestore.FieldValue.serverTimestamp()
        });
        await _auth.signOut();await _app.delete();
        setMensaje({texto:'Usuario creado.',tipo:'ok'});
      }
      setForm({email:'',password:'',rol:'seguimiento',nombre:''});
    }catch(err){setMensaje({texto:'Error: '+err.message,tipo:'error'});}
    finally{setLoading(false);}
  };

  const abrirEditar=(u)=>{
    setUsuarioEdit(u);
    setForm({email:u.email,nombre:u.nombre||'',rol:u.rol,password:''});
    setModal(true);
  };

  const cambiarRol=async(uid,nuevoRol)=>{
    await db.collection('coosanroque_usuarios').doc(uid).update({rol:nuevoRol});
  };

  const resetPassword=async(email)=>{
    try{
      await auth.sendPasswordResetEmail(email);
      setMensaje({texto:'Email de recuperacion enviado a '+email,tipo:'ok'});
      setTimeout(()=>setMensaje({texto:'',tipo:''}),5000);
    }catch(err){setMensaje({texto:'Error: '+err.message,tipo:'error'});}
  };

  const eliminarUsuario=async(uid,email)=>{
    if(!window.confirm('Eliminar usuario '+email+'?'))return;
    await db.collection('coosanroque_usuarios').doc(uid).delete();
  };

  const badges={admin:{bg:'#EEF2FF',color:'#4F46E5',label:'Admin'},seguimiento:{bg:'#F0FDF4',color:'#166534',label:'Seguimiento'}};

  return(<div>
    <div className="page-header">
      <h1>Usuarios</h1>
      <button className="btn-primary" style={{width:'auto'}}
        onClick={()=>{setUsuarioEdit(null);setForm({email:'',password:'',rol:'seguimiento',nombre:''});setModal(true);}}>
        + Nuevo Usuario
      </button>
    </div>
    {mensaje.texto&&<div className={mensaje.tipo==='ok'?'success-message':'error-message'}>{mensaje.texto}</div>}
    <div className="card">
      <table className="tabla">
        <thead><tr><th>Nombre / Email</th><th>Rol</th><th>Cambiar Rol</th><th>Acciones</th></tr></thead>
        <tbody>{usuarios.map(u=>{
          const b=badges[u.rol]||badges.seguimiento;
          const esTu=(u.id===user.uid);
          return(
            <tr key={u.id}>
              <td>
                <strong>{u.nombre||u.email}</strong>
                {esTu&&<span style={{marginLeft:'0.5rem',fontSize:'0.75rem',color:'#6B7280'}}>(Tu)</span>}
                <div style={{fontSize:'0.8rem',color:'#6B7280'}}>{u.email}</div>
              </td>
              <td><span style={{padding:'0.25rem 0.75rem',borderRadius:'12px',fontSize:'0.8rem',fontWeight:700,background:b.bg,color:b.color}}>{b.label}</span></td>
              <td>{!esTu&&(
                <select value={u.rol} onChange={e=>cambiarRol(u.id,e.target.value)}
                  style={{padding:'0.4rem 0.5rem',borderRadius:'6px',border:'2px solid #E5E7EB',fontSize:'0.875rem'}}>
                  <option value="admin">Admin</option>
                  <option value="seguimiento">Seguimiento</option>
                </select>
              )}</td>
              <td>{!esTu&&(
                <div style={{display:'flex',gap:'0.4rem',flexWrap:'wrap'}}>
                  <button className="btn-edit" onClick={()=>abrirEditar(u)}>Editar</button>
                  <button style={{padding:'0.4rem 0.6rem',fontSize:'0.8rem',background:'#FEF3C7',color:'#92400E',border:'1px solid #F59E0B',borderRadius:'6px',cursor:'pointer'}}
                    onClick={()=>resetPassword(u.email)}>Reset Clave</button>
                  <button className="btn-secondary" style={{padding:'0.4rem 0.6rem',fontSize:'0.8rem'}}
                    onClick={()=>eliminarUsuario(u.id,u.email)}>Eliminar</button>
                </div>
              )}</td>
            </tr>
          );
        })}</tbody>
      </table>
    </div>
    {modal&&<div className="modal-overlay" onClick={()=>{setModal(false);setUsuarioEdit(null);}}>
      <div className="modal" onClick={e=>e.stopPropagation()}>
        <div className="modal-header">
          <h2>{usuarioEdit?'Editar Usuario':'Nuevo Usuario'}</h2>
          <button className="btn-cerrar" onClick={()=>{setModal(false);setUsuarioEdit(null);setForm({email:'',password:'',rol:'seguimiento',nombre:''});}}>x</button>
        </div>
        <div className="modal-body">
          <form onSubmit={crearUsuario}>
            <div className="form-group">
              <label>Nombre</label>
              <input type="text" value={form.nombre} onChange={e=>setForm({...form,nombre:e.target.value})} placeholder="Nombre completo"/>
            </div>
            <div className="form-group">
              <label>Email</label>
              <input type="email" value={form.email} onChange={e=>setForm({...form,email:e.target.value})}
                required placeholder="usuario@correo.com" readOnly={!!usuarioEdit}
                style={{background:usuarioEdit?'#F3F4F6':''}}/>
            </div>
            {!usuarioEdit&&<div className="form-group">
              <label>Contrasena</label>
              <input type="password" value={form.password} onChange={e=>setForm({...form,password:e.target.value})}
                required placeholder="Minimo 6 caracteres" minLength={6}/>
            </div>}
            <div className="form-group">
              <label>Rol</label>
              <select value={form.rol} onChange={e=>setForm({...form,rol:e.target.value})}>
                <option value="admin">Admin - Control total</option>
                <option value="seguimiento">Seguimiento - Solo registrar avances</option>
              </select>
            </div>
            <button type="submit" className="btn-primary" disabled={loading}>
              {loading?'Espere...':(usuarioEdit?'Guardar Cambios':'Crear Usuario')}
            </button>
          </form>
        </div>
      </div>
    </div>}
  </div>);
};const ModalImpresionDashboard=({entidad,datos,onClose})=>{
  const{ejes=[],objetivos=[],indicadores=[],seguimientos=[]}=datos;
  return(<div className="modal-overlay"><div className="modal" style={{maxWidth:'900px',width:'95%',maxHeight:'90vh',overflow:'auto'}}>
    <div className="modal-header"><h2>Informe - {entidad.nombre}</h2>
      <div style={{display:'flex',gap:'0.5rem'}}>
        <button className="btn-primary" style={{width:'auto'}} onClick={()=>window.print()}>Imprimir</button>
        <button className="btn-cerrar" onClick={onClose}>x</button>
      </div>
    </div>
    <div className="modal-body">
      <h3>Resumen General</h3>
      <table className="tabla"><thead><tr><th>Eje</th><th>Objetivos</th><th>Indicadores</th><th>Con Seguimiento</th></tr></thead>
        <tbody>{ejes.map(eje=>{
          const objs=objetivos.filter(o=>o.ejeId===eje.id);
          const inds=indicadores.filter(i=>objs.some(o=>o.id===i.objetivoId));
          const conSeg=inds.filter(i=>seguimientos.some(s=>s.indicadorId===i.id));
          return<tr key={eje.id}><td>{eje.nombre}</td><td>{objs.length}</td><td>{inds.length}</td><td>{conSeg.length}</td></tr>;
        })}</tbody>
      </table>
      <h3 style={{marginTop:'1.5rem'}}>Detalle por Indicador</h3>
      <table className="tabla"><thead><tr><th>Indicador</th><th>Objetivo</th><th>Meta Anual</th><th>Ultimo Avance</th><th>Score</th></tr></thead>
        <tbody>{indicadores.map(ind=>{
          const obj=objetivos.find(o=>o.id===ind.objetivoId);
          const segs=seguimientos.filter(s=>s.indicadorId===ind.id);
          const ultimo=segs.length>0?segs[segs.length-1]:null;
          return<tr key={ind.id}>
            <td>{ind.nombre}</td><td>{obj?.nombre}</td>
            <td>{ind.meta} {ind.unidad}</td>
            <td>{ultimo?ultimo.avance+' '+ind.unidad:'-'}</td>
            <td>{ultimo?<div className={'semaforo '+(ultimo.score||'')} style={{display:'inline-block'}}>{ultimo.score==='critico'&&'Critico'}{ultimo.score==='precaucion'&&'Precaucion'}{ultimo.score==='optimo'&&'Optimo'}</div>:'-'}</td>
          </tr>;
        })}</tbody>
      </table>
    </div>
  </div></div>);
};const ModalImpresionPlaneacion=({entidad,datos,onClose})=>{
  const{ejes=[],objetivos=[],indicadores=[]}=datos;
  return(<div className="modal-overlay"><div className="modal" style={{maxWidth:'900px',width:'95%',maxHeight:'90vh',overflow:'auto'}}>
    <div className="modal-header"><h2>Planeacion - {entidad.nombre}</h2>
      <div style={{display:'flex',gap:'0.5rem'}}>
        <button className="btn-primary" style={{width:'auto'}} onClick={()=>window.print()}>Imprimir</button>
        <button className="btn-cerrar" onClick={onClose}>x</button>
      </div>
    </div>
    <div className="modal-body">
      {ejes.map(eje=>{
        const objsEje=objetivos.filter(o=>o.ejeId===eje.id);
        return(<div key={eje.id} style={{marginBottom:'1.5rem',borderLeft:'4px solid #4F46E5',paddingLeft:'1rem'}}>
          <h3 style={{color:'#4F46E5',margin:'0 0 0.5rem'}}>{eje.nombre}</h3>
          {objsEje.map(obj=>{
            const indsObj=indicadores.filter(i=>i.objetivoId===obj.id);
            return(<div key={obj.id} style={{marginLeft:'1rem',marginBottom:'0.75rem'}}>
              <h4 style={{margin:'0 0 0.25rem'}}>{obj.nombre}</h4>
              {indsObj.map(ind=><div key={ind.id} style={{marginLeft:'1rem',fontSize:'0.875rem',color:'#374151',padding:'0.25rem 0'}}>
                {ind.nombre} - Meta: {ind.meta} {ind.unidad}
              </div>)}
            </div>);
          })}
        </div>);
      })}
    </div>
  </div></div>);
};
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
